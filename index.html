<!DOCTYPE html>

<html>
<head>
<style>
#myCanvas{
    position: absolute;
    border: 1px solid green;
}

</style>
</head>
<body onload="initGame()">
    <img style="display: none;" id = "perfectStone" src = "./GameAssets/stone.png" width = "50" height = "50" alt="A Stone">
    <img style="display: none;" id = "okStone" src = "./GameAssets/stone2.png" width = "50" height = "50" alt="An ok Stone">
    <canvas id="myCanvas" width="500" height="400"></canvas>
    <script src = "Drop7_GameMechanic.js"></script>
    <script>

        function initGame() {

        }
        var turnCount = 0;
        var pushableAreaOffset = 8;
        var myGameArray = new Array(7);
        var updateInterval;
        var eventEnabled = true;
        var newDisctoAdd = Math.floor(Math.random() * 7 + 1);
        for (i = 0; i < myGameArray.length; i++) {
            myGameArray[i] = new Array();
        }
        function initGameArray () {

        }
        function resetArray(){
            for (var i = 0 ; i < myGameArray.length ; i++){
                myGameArray[i] = new Array();
            }
            Update();
        }
        function executeAndUpdate() {
            var copyOfArray = deepCopyArray(myGameArray);
            GameExecution(myGameArray);
            Update();

            if (arraysEqual(myGameArray, copyOfArray)){
                clearInterval(updateInterval);
                eventEnabled = true;
            }
        }
        function showGameArray(gameArray) {

        }
        function onMouseClick(event) {
            if (eventEnabled) {
                if (event.x >= 25 + pushableAreaOffset && event.x <= 375 + pushableAreaOffset && event.y >= 25 && event.y <= 375) {
                    for (var i = 1; i < 8; i++) {
                        if (event.x < 25 + pushableAreaOffset + 50 * i) {
                            turnCount++;
                            myGameArray[i - 1].push(newDisctoAdd);
                            break;
                        }
                    }
                    eventEnabled = false;
                    newDisctoAdd = Math.floor(Math.random() * 8 + 1);
                    //newDisctoAdd = -2;
                    if (newDisctoAdd == 8) newDisctoAdd = -2;
                    Update();
                    var isCombo = true;
                    updateInterval = setInterval(executeAndUpdate, 500);
                    if (turnCount % 15 == 0) {
                        PushStones(myGameArray);
                    }
                }
            }
            if (event.x >= 400 + pushableAreaOffset && event.x <= 475 + pushableAreaOffset && event.y >= 325 && event.y <= 350){
                console.log("reset");
                resetArray();
            }
        }

        var canvas = document.getElementById("myCanvas");
        canvas.addEventListener("mousedown", onMouseClick);
        var ctx = canvas.getContext("2d");
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        
        var counter = 0;
        for (var i = 0; i < myGameArray.length; i++) {
            for (var j = 0 ; j < myGameArray[i].length ; j++) {
                ctx.fillText(myGameArray[i][j], 50 * (i + 1), canvas.height - 50 * (j + 1) + 6);
            }
        }
        function Update(){
            clearCanvas();
            UpdateCanvas();
        }
        UpdateCanvas();
        function UpdateCanvas(){
            ctx.rect(25, 25, 350, 350);
            ctx.stroke();
            ctx.rect(400, 325, 75, 25);
            ctx.stroke();
            ctx.beginPath();
            for (var i = 50; i < 375; i += 50) {
                ctx.moveTo(25 + i, 25);
                ctx.lineTo(25 + i, 375);
                ctx.moveTo(25, 25 + i);
                ctx.lineTo(375, 25 + i)
                ctx.stroke();
            }
            ctx.fillText("next:", 425, 50);
            ctx.fillText("reset?", 437, 344);
            for (var i = 0; i < myGameArray.length; i++) {
                for (var j = 0 ; j < myGameArray[i].length ; j++) {
                    if (myGameArray[i][j] == -2){
                        ctx.drawImage(document.getElementById("perfectStone"), 50 * (i + 1) - 25, canvas.height - 50 * (j + 1) - 25);
                    }
                    else if (myGameArray[i][j] == -1){
                        ctx.drawImage(document.getElementById("okStone"), 50 * (i + 1) - 25, canvas.height - 50 * (j + 1) - 25);
                    }
                    else{
                       ctx.fillText(myGameArray[i][j], 50 * (i + 1), canvas.height - 50 * (j + 1) + 6);
                    }
                }
            }
            if (newDisctoAdd == -2){
                ctx.drawImage(document.getElementById("perfectStone"), 400, 75);
            }
            else{
                ctx.fillText(newDisctoAdd, 425, 100);
            }
        }
        function clearCanvas(){
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }


    </script>
</body>
</html>
